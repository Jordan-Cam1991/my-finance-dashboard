<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Dashboard</title>
    <!-- Firebase SDKs -->
    <script type="module">
        // Unifying all Firebase SDK versions to 11.9.1 for consistency
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";

        // Expose Firebase objects globally for use in the main script block
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            getFirestore,
            doc,
            setDoc,
            onSnapshot,
            getAnalytics
        };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons (e.g., sun/moon for dark mode toggle) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- Chosen Palette: Warm Neutrals (Slate, Zinc, Stone) -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
            color: #1e293b; /* slate-900 */
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 300px;
            max-height: 300px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
                max-height: 350px;
            }
        }
        .tab-active {
            border-color: #4f46e5; /* indigo-600 */
            color: #4f46e5;
            font-weight: 600;
        }
        .form-label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 500;
            color: #475569; /* slate-600 */
        }
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #cbd5e1; /* slate-300 */
            border-radius: 0.375rem;
            background-color: #ffffff;
            color: #1e293b; /* slate-900 */
            font-size: 0.875rem;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }
        /* Spinner CSS */
        .spinner-border {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            vertical-align: -0.125em;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            -webkit-animation: .75s linear infinite spinner-border;
            animation: .75s linear infinite spinner-border;
        }
        @-webkit-keyframes spinner-border {
            to { -webkit-transform: rotate(360deg); transform: rotate(360deg); }
        }
        @keyframes spinner-border {
            to { -webkit-transform: rotate(360deg); transform: rotate(360deg); }
        }
        .visually-hidden {
            position: absolute !important;
            width: 1px !important;
            height: 1px !important;
            padding: 0 !important;
            margin: -1px !important;
            overflow: hidden !important;
            clip: rect(0,0,0,0) !important;
            white-space: nowrap !important;
            border: 0 !important;
        }
        #loading-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .text-overrun {
            color: #ef4444; /* red-500 */
            font-weight: 700;
        }
        /* Custom styles for improved UI/UX */
        .card {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0; /* slate-200 */
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .section-header {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 700; /* font-bold */
            color: #1e293b; /* slate-900 */
            margin-bottom: 1rem;
            transition: color 0.3s ease;
        }
        .sub-section-header {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            color: #334155; /* slate-700 */
            margin-bottom: 0.75rem;
            transition: color 0.3s ease;
        }
        .btn-primary {
            background-color: #4f46e5; /* indigo-600 */
            color: #ffffff;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* indigo-700 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-secondary {
            background-color: #64748b; /* slate-500 */
            color: #ffffff;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .btn-secondary:hover {
            background-color: #475569; /* slate-600 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-danger {
            background-color: #ef4444; /* red-500 */
            color: #ffffff;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* red-600 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-success {
            background-color: #22c55e; /* green-500 */
            color: #ffffff;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .btn-success:hover {
            background-color: #16a34a; /* green-600 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .log-entry:nth-child(odd) {
            background-color: #f1f5f9; /* slate-100 */
        }
        .log-entry:nth-child(even) {
            background-color: #ffffff;
        }
        /* Toast Message CSS */
        #toast-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 100;
            display: flex;
            flex-direction: column-reverse; /* New toasts appear above old ones */
            gap: 0.5rem;
        }
        .toast-message {
            background-color: #1e293b; /* slate-900 */
            color: #f1f5f9; /* slate-100 */
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            opacity: 0;
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            transform: translateY(20px);
            max-width: 300px;
            font-size: 0.875rem;
        }
        .toast-message.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast-message.success {
            background-color: #22c55e; /* green-500 */
        }
        .toast-message.error {
            background-color: #ef4444; /* red-500 */
        }
        .toast-message.info {
            background-color: #3b82f6; /* blue-500 */
        }
        /* LLM Loading Spinner */
        #llm-spinner {
            display: none; /* Hidden by default */
            margin-top: 1rem;
            text-align: center;
        }
        #llm-spinner .spinner-border {
            width: 1.5rem;
            height: 1.5rem;
            border-width: 0.2em;
            color: #4f46e5; /* indigo-600 */
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #1a202c; /* dark slate-900 */
            color: #e2e8f0; /* slate-200 */
        }
        body.dark-mode .card {
            background-color: #2d3748; /* dark slate-800 */
            border-color: #4a5568; /* dark slate-700 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.12);
        }
        body.dark-mode .section-header,
        body.dark-mode .sub-section-header {
            color: #f8fafc; /* slate-50 */
        }
        body.dark-mode .form-label {
            color: #cbd5e1; /* slate-300 */
        }
        body.dark-mode .form-input,
        body.dark-mode .form-textarea,
        body.dark-mode .form-select {
            background-color: #4a5568; /* slate-700 */
            color: #f8fafc; /* slate-50 */
            border-color: #64748b; /* slate-600 */
        }
        body.dark-mode .log-entry:nth-child(odd) {
            background-color: #2d3748; /* dark slate-800 */
        }
        body.dark-mode .log-entry:nth-child(even) {
            background-color: #4a5568; /* dark slate-700 */
        }
        body.dark-mode #variable-categories-list {
            background-color: #2d3748; /* dark slate-800 */
            border-color: #4a5568; /* dark slate-700 */
        }
        body.dark-mode .tab-button {
            color: #cbd5e1; /* slate-300 */
        }
        body.dark-mode .tab-button.tab-active {
            border-color: #6366f1; /* indigo-500 */
            color: #818cf8; /* indigo-400 */
        }
        body.dark-mode .text-slate-500 {
            color: #a0aec0; /* slate-400 */
        }
        body.dark-mode .text-slate-600 {
            color: #cbd5e1; /* slate-300 */
        }
        body.dark-mode .text-slate-700 {
            color: #e2e8f0; /* slate-200 */
        }
        body.dark-mode .text-slate-800 {
            color: #f8fafc; /* slate-50 */
        }
        body.dark-mode .text-slate-900 {
            color: #f8fafc; /* slate-50 */
        }
        body.dark-mode #no-actual-variable-spending-message,
        body.dark-mode #no-actuals-message,
        body.dark-mode #no-savings-used-message,
        body.dark-mode #no-variable-categories-message {
            color: #94a3b8; /* slate-400 */
        }
        body.dark-mode .bg-slate-100 {
            background-color: #4a5568; /* slate-700 */
        }
        body.dark-mode .border-slate-200 {
            border-color: #4a5568; /* slate-700 */
        }
        body.dark-mode table thead th {
            color: #f8fafc;
        }
        body.dark-mode .chart-container canvas {
            background-color: #2d3748; /* Darker background for charts */
            border-radius: 0.5rem;
        }
        body.dark-mode #financial-tips-output {
            background-color: #1e293b; /* darker indigo for tips */
            color: #93c5fd; /* light blue for text */
        }
        body.dark-mode #llm-spinner .spinner-border {
            color: #818cf8; /* indigo-400 */
        }
        .delete-btn {
            background-color: transparent;
            border: none;
            color: #ef4444; /* red-500 */
            font-size: 0.8rem;
            margin-left: 0.5rem;
            cursor: pointer;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            transition: background-color 0.15s ease-in-out;
        }
        .delete-btn:hover {
            background-color: rgba(239, 68, 68, 0.1); /* light red background on hover */
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="loading-overlay">
        <div class="spinner-border animate-spin inline-block w-8 h-8 border-4 rounded-full border-indigo-500 border-r-transparent" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="ml-3 text-lg text-indigo-700">Loading data...</p>
    </div>

    <!-- Confirmation Modal Structure -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <h3 class="text-xl font-semibold mb-4 text-slate-900 dark:text-slate-100">Confirm Archive</h3>
            <p class="text-slate-700 dark:text-slate-300 mb-6">Are you sure you want to archive the current week and start a new one? This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-archive-modal-btn" class="btn-danger">Confirm Archive</button>
                <button id="cancel-archive-modal-btn" class="btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-8 relative">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Financial Dashboard</h1>
            <button id="dark-mode-toggle" class="absolute top-0 right-0 p-2 rounded-full bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 transition-colors duration-300" aria-label="Toggle dark mode">
                <i class="fas fa-sun" id="dark-mode-icon"></i>
            </button>
        </header>

        <!-- Moved Week Navigation Controls Here -->
        <div class="flex flex-col md:flex-row items-center justify-center gap-4 mb-6 card p-4">
            <button id="prev-week-btn" class="btn-secondary px-4 py-2 rounded-md"><i class="fas fa-arrow-left"></i> Previous Week</button>
            <input type="date" id="week-selector" class="form-input text-center max-w-xs" aria-label="Select Week">
            <button id="next-week-btn" class="btn-secondary px-4 py-2 rounded-md">Next Week <i class="fas fa-arrow-right"></i></button>
        </div>

        <main>
            <section id="key-metrics" class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mb-8">
                <div class="card text-center">
                    <h3 class="text-sm md:text-base font-medium text-slate-500">Combined Weekly Income</h3>
                    <p class="text-2xl md:text-3xl font-bold text-green-600 mt-1" id="metric-income">$0.00</p>
                </div>
                <div class="card text-center">
                    <h3 class="text-sm md:text-base font-medium text-slate-500">Total Weekly Expenses</h3>
                    <p class="text-2xl md:text-3xl font-bold text-red-600 mt-1" id="metric-expenses">$0.00</p>
                </div>
                <div class="card text-center">
                    <h3 class="text-sm md:text-base font-medium text-slate-500">Weekly Savings Goal</h3>
                    <p class="text-2xl md:text-3xl font-bold text-blue-600 mt-1" id="metric-savings">$0.00</p>
                </div>
                <div class="card text-center">
                    <h3 class="text-sm md:text-base font-medium text-slate-500">Net Weekly Position</h3>
                    <p class="text-2xl md:text-3xl font-bold text-slate-700 mt-1" id="metric-net">$0.00</p>
                </div>
            </section>

            <nav class="flex border-b border-slate-200 mb-6 overflow-x-auto">
                <button data-tab="dashboard-overview" class="tab-button py-3 px-4 md:px-6 border-b-2 tab-active whitespace-nowrap">Current Week Overview</button>
                <button data-tab="expenses" class="tab-button py-3 px-4 md:px-6 border-b-2 border-transparent text-slate-500 hover:text-slate-700 whitespace-nowrap">Expenses Deep Dive</button>
                <button data-tab="savings" class="tab-button py-3 px-4 md:px-6 border-b-2 border-transparent text-slate-500 hover:text-slate-700 whitespace-nowrap">Savings Goals</button>
                <button data-tab="data-input" class="tab-button py-3 px-4 md:px-6 border-b-2 border-transparent text-slate-500 hover:text-slate-700 whitespace-nowrap">Data Input</button>
            </nav>

            <div id="tab-content">
                
                <section id="dashboard-overview" class="tab-pane">
                    <div class="card mb-6">
                        <h2 class="section-header">Log Actual Weekly Variable Spending</h2>
                        <p class="text-sm text-slate-500 mb-4">Enter individual variable purchases made for the selected week to track actual spending.</p>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-3 items-end">
                            <div>
                                <label for="input-actual-variable-category" class="form-label text-sm">Category</label>
                                <select id="input-actual-variable-category" class="form-input text-sm" aria-label="Spending Category">
                                    <!-- Options populated dynamically by JS -->
                                </select>
                            </div>
                            <div>
                                <label for="input-actual-variable-amount" class="form-label text-sm">Amount</label>
                                <input type="number" id="input-actual-variable-amount" class="form-input text-sm" placeholder="$ 75" aria-label="Spending Amount">
                            </div>
                            <div id="description-input-group">
                                <label for="input-actual-variable-description" class="form-label text-sm">Description (Optional)</label>
                                <input type="text" id="input-actual-variable-description" class="form-input text-sm" placeholder="e.g. Had lunch with friends" aria-label="Spending Description">
                            </div>
                            <div>
                                <label for="input-actual-variable-date" class="form-label text-sm">Date</label>
                                <input type="date" id="input-actual-variable-date" class="form-input text-sm" aria-label="Spending Date">
                            </div>
                            <div class="md:col-span-4 flex justify-end">
                                <button type="button" id="add-actual-variable-spending-button" class="btn-primary w-full md:w-auto">
                                    Log Spending
                                </button>
                            </div>
                        </div>
                        <div id="actual-variable-spending-log-display" class="mt-4 p-3 rounded-md max-h-40 overflow-y-auto text-sm text-slate-600 border border-slate-200">
                            <p class="text-center text-slate-400" id="no-actual-variable-spending-message">No actual variable spending logged yet this week.</p>
                            <ul id="actual-variable-spending-list" class="space-y-1">
                                <!-- Logged entries will appear here -->
                            </ul>
                        </div>
                    </div>

                    <div class="card mb-6">
                        <h2 class="section-header">Weekly Variable Spending Snapshot</h2>
                        <p class="text-sm text-slate-500 mb-4">Compare your budgeted amounts with your actual spending for the current week. Click on a budget amount to edit it.</p>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-100 text-slate-600">
                                    <tr>
                                        <th class="p-3 font-semibold">Category</th>
                                        <th class="p-3 font-semibold text-right">Budgeted</th>
                                        <th class="p-3 font-semibold text-right">Actual</th>
                                        <th class="p-3 font-semibold text-right">Difference</th>
                                    </tr>
                                </thead>
                                <tbody id="variable-spending-summary-table">
                                    <!-- Variable spending summary will be rendered here -->
                                </tbody>
                                <tfoot>
                                    <tr class="border-t-2 border-slate-200 font-bold">
                                        <td class="p-3">Total Variable</td>
                                        <td class="p-3 text-right" id="total-variable-budgeted">$0.00</td>
                                        <td class="p-3 text-right" id="total-variable-actual">$0.00</td>
                                        <td class="p-3 text-right" id="total-variable-difference">$0.00</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <button type="button" id="archive-week-button" class="btn-primary mt-6 w-full">
                            Archive Current Week & Start New
                        </button>
                        <div id="archive-week-message" class="message-box hidden" role="alert"></div>
                    </div>

                    <div class="card mb-6">
                        <h2 class="section-header">Combined Weekly Summary</h2>
                        <p class="text-slate-500 mt-1 mb-4">An overview of our household's income and how it's allocated per week.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="sub-section-header text-center">Weekly Financial Allocation</h3>
                                <div class="chart-container mx-auto mt-4 max-w-sm">
                                    <canvas id="combinedWeeklyChart"></canvas>
                                </div>
                            </div>
                            <div class="flex flex-col justify-center">
                                <h3 class="sub-section-header text-center mb-4">Weekly Financial Position</h3>
                                <ul class="space-y-2 text-sm">
                                    <li class="flex justify-between items-center"><span class="font-medium">Combined Net Pay:</span> <span class="font-semibold text-green-600" id="combined-net-pay"></span></li>
                                    <li class="flex justify-between items-center"><span class="font-medium">Total Fixed Expenses:</span> <span class="font-semibold text-red-600" id="combined-fixed-expenses"></span></li>
                                    <li class="flex flex-col">
                                        <div class="flex justify-between items-center w-full">
                                            <span class="font-medium">Total Actual Variable Spending:</span> 
                                            <span class="font-semibold text-orange-700" id="combined-actual-variable-spending"></span>
                                        </div>
                                        <ul id="weekly-actual-variable-spending-list" class="ml-4 text-xs text-slate-500 list-disc list-inside mt-1 space-y-0.5">
                                            <!-- Actual variable spending items will be listed here -->
                                        </ul>
                                    </li>
                                    <li class="flex justify-between items-center"><span class="font-medium">Total Savings Contribution:</span> <span class="font-semibold text-blue-600" id="combined-savings-contribution"></span></li>
                                    <li class="flex justify-between items-center"><span class="font-medium">Carry Over from Last Week:</span> <span class="font-semibold" id="combined-carry-over">$0.00</span></li>
                                    <li class="flex justify-between items-center border-t pt-2 mt-2"><span class="font-bold">Remaining Disposable:</span> <span class="font-bold text-slate-800" id="combined-disposable"></span></li>
                                </ul>
                            </div>
                        </div>
                        <button type="button" id="get-financial-tips-button" class="btn-primary w-full md:w-auto mt-6">
                            ✨ Get Financial Tips
                        </button>
                        <div id="llm-spinner" class="hidden">
                            <div class="spinner-border animate-spin inline-block" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="ml-2 text-sm text-indigo-700">Generating tips...</p>
                        </div>
                        <div id="financial-tips-output" class="mt-4 p-4 bg-indigo-50 rounded-md text-indigo-800 hidden">
                            <!-- LLM generated tips will appear here -->
                        </div>
                    </div>

                    <div class="card">
                        <h2 class="section-header">Historical Net Position</h2>
                        <p class="text-sm text-slate-500 mb-4">Track your weekly net financial position over time (from archived weeks).</p>
                        <div class="chart-container">
                            <canvas id="historicalNetPositionChart"></canvas>
                        </div>
                    </div>
                </section>

                <section id="expenses" class="tab-pane hidden">
                    <div class="grid lg:grid-cols-5 gap-6">
                        <div class="lg:col-span-3 card">
                             <h2 class="section-header">Fixed Expenses Breakdown</h2>
                             <p class="text-slate-500 mb-4 text-sm">All recurring bills converted to their weekly equivalent for easy comparison.</p>
                             <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-slate-100 text-slate-600">
                                        <tr>
                                            <th class="p-3 font-semibold">Category</th>
                                            <th class="p-3 font-semibold">Provider</th>
                                            <th class="p-3 font-semibold text-right">Weekly Cost</th>
                                        </tr>
                                    </thead>
                                    <tbody id="fixed-expenses-table">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="lg:col-span-2 card">
                            <h2 class="section-header">Top Spending Categories</h2>
                             <p class="text-sm text-slate-500 mb-4">A visual look at where most of the money goes each week.</p>
                            <div class="chart-container">
                                <canvas id="expensesBarChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="card mt-6">
                        <h2 class="section-header">Expense Trend Analysis</h2>
                        <p class="text-sm text-slate-500 mb-4">Track spending trends for specific categories over time.</p>
                        <div class="mb-4">
                            <label for="trend-category-select" class="form-label text-sm">Select Category for Trend:</label>
                            <select id="trend-category-select" class="form-input text-sm">
                                <option value="">All Categories</option>
                                <!-- Categories populated by JS -->
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="expenseTrendChart"></canvas>
                        </div>
                    </div>
                </section>

                <section id="savings" class="tab-pane hidden">
                    <div class="text-center mb-6">
                        <h2 class="section-header">Savings Tracker</h2>
                        <p class="text-slate-500 mt-1">Our primary savings objective and projected path to success.</p>
                    </div>
                    <div class="grid lg:grid-cols-2 gap-6">
                        <div class="card flex flex-col justify-center">
                            <h3 class="sub-section-header">Goal Progress</h3>
                            <div class="w-full bg-slate-200 rounded-full h-6 mb-2">
                                <div id="progress-bar" class="bg-indigo-600 h-6 rounded-full text-center text-white text-sm flex items-center justify-center font-semibold" style="width: 0%;">0%</div>
                            </div>
                            <ul class="mt-4 space-y-2 text-sm">
                                <li class="flex justify-between"><span class="font-medium text-slate-600">Amount Saved:</span> <span id="savings-current-display" class="font-bold"></span></li>
                                <li class="flex justify-between"><span class="font-medium text-slate-600">Target:</span> <span id="savings-target-display" class="font-bold"></span></li>
                                <li class="flex justify-between"><span class="font-medium text-slate-600">Amount Remaining:</span> <span id="savings-remaining" class="font-bold text-indigo-700"></span></li>
                                <li class="flex justify-between border-t mt-2 pt-2"><span class="font-medium text-slate-600">Est. Completion Date:</span> <span id="savings-eta" class="font-bold"></span></li>
                            </ul>
                            <div id="savings-milestone-message" class="message-box hidden mt-4" role="alert"></div>
                        </div>
                        <div class="card">
                             <h3 class="sub-section-header">Projected Growth</h3>
                             <p class="text-sm text-slate-500 mb-4">This chart shows the projected increase in our savings balance over the coming weeks.</p>
                            <div class="chart-container">
                                <canvas id="savingsLineChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mt-6">
                        <h3 class="sub-section-header">Log Actual Weekly Savings</h3>
                        <p class="text-sm text-slate-500 mb-4">Add the amount you actually saved this week to update your total progress.</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3 items-end">
                            <div>
                                <label for="input-weekly-actual-amount" class="form-label text-sm">Amount Saved This Week</label>
                                <input type="number" id="input-weekly-actual-amount" class="form-input text-sm" placeholder="$ 550" aria-label="Amount Saved This Week">
                            </div>
                            <div>
                                <label for="input-weekly-actual-date" class="form-label text-sm">Date of Saving (Optional)</label>
                                <input type="date" id="input-weekly-actual-date" class="form-input text-sm" aria-label="Date of Saving">
                            </div>
                            <div class="flex items-end">
                                <button type="button" id="add-actual-saving-button" class="btn-primary w-full">
                                    Log Saving
                                </button>
                            </div>
                        </div>
                        <div id="actual-savings-log-display" class="mt-4 p-3 rounded-md max-h-40 overflow-y-auto text-sm text-slate-600 border border-slate-200">
                            <p class="text-center text-slate-400" id="no-actuals-message">No actual savings logged yet.</p>
                            <ul id="actual-savings-list" class="space-y-1">
                                <!-- Logged entries will appear here -->
                            </ul>
                        </div>
                    </div>

                    <div class="card mt-6">
                        <h3 class="sub-section-header">Log Savings Used</h3>
                        <p class="text-sm text-slate-500 mb-4">Record instances where savings were withdrawn or used for specific purposes.</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3 items-end">
                            <div>
                                <label for="input-savings-used-amount" class="form-label text-sm">Amount Used</label>
                                <input type="number" id="input-savings-used-amount" class="form-input text-sm" placeholder="$ 200" aria-label="Amount of Savings Used">
                            </div>
                            <div>
                                <label for="input-savings-used-reason" class="form-label text-sm">Reason</label>
                                <input type="text" id="input-savings-used-reason" class="form-input text-sm" placeholder="e.g. Emergency repair" aria-label="Reason for Savings Use">
                            </div>
                            <div>
                                <label for="input-savings-used-date" class="form-label text-sm">Date (Optional)</label>
                                <input type="date" id="input-savings-used-date" class="form-input text-sm" aria-label="Date Savings Used">
                            </div>
                            <div class="flex items-end md:col-span-3">
                                <button type="button" id="add-savings-used-button" class="btn-secondary w-full">
                                    Log Savings Used
                                </button>
                            </div>
                        </div>
                        <div id="actual-savings-used-log-display" class="mt-4 p-3 rounded-md max-h-40 overflow-y-auto text-sm text-slate-600 border border-slate-200">
                            <p class="text-center text-slate-400" id="no-savings-used-message">No savings used logged yet.</p>
                            <ul id="actual-savings-used-list" class="space-y-1">
                                <!-- Logged uses will appear here -->
                            </ul>
                        </div>
                    </div>
                </section>

                <section id="data-input" class="tab-pane hidden">
                    <div class="card">
                        <h2 class="section-header">Update Your Financial Data</h2>

                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <h3 class="sub-section-header">Income (Weekly Net)</h3>
                                <div class="mb-4">
                                    <label for="input-combined-income" class="form-label">Combined Weekly Net Salary</label>
                                    <input type="number" id="input-combined-income" class="form-input" readonly aria-label="Combined Weekly Net Salary">
                                </div>
                                <div class="mb-4">
                                    <label for="input-emma-income" class="form-label">Emma's Weekly Net Salary</label>
                                    <input type="number" id="input-emma-income" class="form-input" value="0" placeholder="$ 0" aria-label="Emma's Weekly Net Salary">
                                </div>
                                <div class="mb-0">
                                    <label for="input-jordan-income" class="form-label">Jordan's Weekly Net Salary</label>
                                    <input type="number" id="input-jordan-income" class="form-input" value="0" placeholder="$ 0" aria-label="Jordan's Weekly Net Salary">
                                </div>
                            </div>
                            <div>
                                <h3 class="sub-section-header">Savings Goal (30k Goal)</h3>
                                <div class="mb-4">
                                    <label for="input-savings-current" class="form-label">Current Savings</label>
                                    <input type="number" id="input-savings-current" class="form-input" value="0" readonly placeholder="$ 0" aria-label="Current Savings">
                                </div>
                                <div class="mb-4">
                                    <label for="input-savings-target" class="form-label">Target Savings</label>
                                    <input type="number" id="input-savings-target" class="form-input" value="0" placeholder="$ 30000" aria-label="Target Savings Goal">
                                </div>
                                <div class="mb-4">
                                    <label for="input-weekly-contribution" class="form-label">Weekly Contribution</labeL>
                                    <input type="number" id="input-weekly-contribution" class="form-input" value="0" placeholder="$ 700" aria-label="Weekly Savings Contribution">
                                </div>
                                <div class="mb-0">
                                    <label for="input-savings-start-date" class="form-label">Start Date (YYYY-MM-DD)</label>
                                    <input type="date" id="input-savings-start-date" class="form-input" aria-label="Savings Start Date"> 
                                </div>
                            </div>
                        </div>

                        <div class="mb-6">
                            <h3 class="sub-section-header">Fixed Expenses</h3>
                            <div id="fixed-expenses-inputs-container">
                                <!-- Fixed expense rows will be added here by JavaScript -->
                            </div>
                            <button type="button" id="add-fixed-expense-button" class="btn-success mt-4">
                                + Add Fixed Expense
                            </button>
                        </div>

                        <div class="mb-6">
                            <h3 class="sub-section-header">Manage Variable Expense Categories</h3>
                            <div class="flex items-end gap-2 mb-3">
                                <div class="flex-grow">
                                    <label for="new-variable-category-name" class="form-label text-sm">New Category Name</label>
                                    <input type="text" id="new-variable-category-name" class="form-input text-sm" placeholder="e.g. Pet Supplies" aria-label="New Variable Category Name">
                                </div>
                                <button type="button" id="add-variable-category-button" class="btn-success py-2 px-4">Add Category</button>
                            </div>
                            <div id="variable-categories-list" class="p-3 rounded-md border border-slate-200 bg-slate-50 max-h-40 overflow-y-auto">
                                <p class="text-center text-slate-400" id="no-variable-categories-message">No custom variable categories added yet.</p>
                                <ul id="variable-categories-ul" class="space-y-1">
                                    <!-- Dynamic list of variable categories -->
                                </ul>
                            </div>
                        </div>

                        <div class="mb-6">
                            <h3 class="sub-section-header">Notification Settings</h3>
                            <div>
                                <label for="input-notification-email" class="form-label">Email for Notifications (In-App Only)</label>
                                <input type="email" id="input-notification-email" class="form-input" placeholder="your.email@example.com" aria-label="Notification Email">
                                <p class="text-xs text-slate-500 mt-1">Note: Email notifications require a backend service (e.g., Firebase Cloud Functions) and are not supported directly by this client-side app. This field is for reference only.</p>
                            </div>
                        </div>

                        <button id="update-dashboard-button" class="btn-primary w-full">
                            Update Dashboard
                        </button>
                        <button id="export-data-button" class="btn-secondary w-full mt-3">
                            Export Data (JSON)
                        </button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script>
        // Helper to get the start of the week (Wednesday) for a given date
        window.getStartOfWeek = function(date) {
            const d = new Date(date);
            const day = d.getDay(); // Sunday - 0, Monday - 1, ..., Wednesday - 3, ..., Saturday - 6
            let diff = d.getDate() - day + (day === 0 ? -4 : 3); // Adjust for Wednesday (3)
            if (day < 3) { // If current day is before Wednesday (Sun, Mon, Tue)
                diff -= 7; // Go back to last Wednesday
            }
            const startOfWeek = new Date(d.setDate(diff));
            startOfWeek.setHours(0, 0, 0, 0); // Set to midnight to avoid time issues
            return startOfWeek;
        };

        // Helper to format date toYYYY-MM-DD for input type="date"
        window.toYYYYMMDD = function(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            const day = d.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Firebase setup
            const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, onSnapshot, getAnalytics } = window.firebase;
            
            let db, auth, userId, analytics;
            // Updated Firebase Configuration for external hosting
            const appId = 'my-finance-dashboard'; // A unique ID for YOUR application's data within Firestore
            const firebaseConfig = {
                apiKey: "AIzaSyBbNEUnjH18OT2CUfnLjSy8JzXsnSG_VFI",
                authDomain: "my-finance-dashboard-b09c7.firebaseapp.com",
                databaseURL: "https://my-finance-dashboard-b09c7-default-rtdb.firebaseio.com",
                projectId: "my-finance-dashboard-b09c7",
                storageBucket: "my-finance-dashboard-b09c7.firebasestorage.app",
                messagingSenderId: "677172862509",
                appId: "1:677172862509:web:f16eee24b979151cbd22a4",
                measurementId: "G-JJ37RP4GYF"
            };

            const loadingOverlay = document.getElementById('loading-overlay');
            
            const formatCurrency = (value) => new Intl.NumberFormat('en-AU', { style: 'currency', currency: 'AUD' }).format(value);
            const formatDate = (date) => {
                if (!(date instanceof Date) || isNaN(date)) {
                    return 'N/A';
                }
                // Check if date is a string inYYYY-MM-DD format
                if (typeof date === 'string' && date.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    return new Date(date + 'T00:00:00').toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric'});
                }
                return date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric'});
            };

            let currentData = {}; 
            let currentViewDate = new Date(); // New: Track the currently viewed week

            const getWeeklyAmount = (amount, freq) => {
                switch (freq.toLowerCase()) {
                    case 'weekly': return amount;
                    case 'fortnightly': return amount / 2;
                    case 'monthly': return amount / 4.33; 
                    case 'quarterly': return amount / 13; 
                    case 'yearly': return amount / 52;
                    default: return 0;
                }
            };

            // Default data for the shared version, with all fixed expenses defaulting to Weekly
            const defaultData = {
                income: {
                    emma: 0,
                    jordan: 0,
                    combined: 0 
                },
                fixedExpenses: [], // Cleared
                variableExpenses: [ // Now only stores names, budgets will be managed separately
                    { name: 'Groceries', budget: 0 },
                    { name: 'Eating Out', budget: 0 },
                    { name: 'Entertainment', budget: 0 },
                    { name: 'Personal Care', budget: 0 },
                    { name: 'Shopping', budget: 0 },
                    { name: 'Transport', budget: 0 },
                    { name: 'Hobbies', budget: 0 },
                    { name: 'Miscellaneous', budget: 0 },
                    { name: 'Coffee', budget: 0 } // Added Coffee to default variable expenses
                ],
                savingsGoal: {
                    name: '30k Goal',
                    startDate: new Date().toISOString().split('T')[0], 
                    current: 0, 
                    target: 0,
                    weeklyContribution: 0,
                    actualSavingsLog: [], // Cleared
                    actualSavingsUsedLog: [], // Cleared
                    milestonesReached: [] // New: Track reached milestones
                },
                actualVariableSpendingLog: [], // Cleared for current week
                historicalSummaries: [], // Cleared, now includes spending breakdown
                notificationEmail: '' // New: Field for notification email
            };


            let combinedWeeklyChart, expensesBarChart, savingsLineChart, historicalNetPositionChart, expenseTrendChart; 

            async function saveData(data) {
                if (!db) { 
                    console.error("Firestore not initialized. Cannot save data.");
                    return;
                }
                try {
                    // Path for shared data
                    const docRef = doc(db, 'artifacts', appId, 'sharedData', 'financialDashboard'); 
                    const dataToSave = JSON.parse(JSON.stringify(data)); 
                    console.log("Saving data to Firestore. Current savings:", dataToSave.savingsGoal.current);
                    await setDoc(docRef, dataToSave);
                    console.log("Data successfully saved to Firestore!");
                } catch (error) {
                    console.error("Error saving data to Firestore:", error);
                }
            }

            // Function to display temporary toast messages
            function showToast(message, type = 'info', duration = 3000) {
                const toastContainer = document.getElementById('toast-container');
                if (!toastContainer) {
                    console.error('Toast container not found.');
                    return;
                }

                const toast = document.createElement('div');
                toast.className = `toast-message ${type}`;
                toast.textContent = message;

                toastContainer.appendChild(toast);

                // Trigger reflow to enable transition
                void toast.offsetWidth; 
                toast.classList.add('show');

                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove(), { once: true });
                }, duration);
            }

            function updateRowWeeklyDisplay(rowDiv) {
                const amountInput = rowDiv.querySelector('.fixed-expense-amount');
                const freqSelect = rowDiv.querySelector('.fixed-expense-freq');
                const weeklyDisplay = rowDiv.querySelector('.fixed-expense-weekly-display');

                const amount = parseFloat(amountInput.value) || 0;
                const freq = freqSelect.value;
                const weeklyValue = getWeeklyAmount(amount, freq);
                weeklyDisplay.textContent = formatCurrency(weeklyValue);
            }

            function createFixedExpenseRow(category = '', provider = '', amount = '', freq = 'Weekly') {
                const container = document.getElementById('fixed-expenses-inputs-container');
                const rowDiv = document.createElement('div');
                rowDiv.className = 'fixed-expense-row grid grid-cols-1 sm:grid-cols-5 gap-4 mb-3 items-end p-3 border border-slate-200 rounded-md bg-slate-50';

                rowDiv.innerHTML = `
                    <div>
                        <label class="form-label text-sm">Category</label>
                        <input type="text" class="form-input text-sm fixed-expense-category" placeholder="e.g. Utilities" value="${category}" aria-label="Fixed Expense Category">
                    </div>
                    <div>
                        <label class="form-label text-sm">Provider</label>
                        <input type="text" class="form-input text-sm fixed-expense-provider" placeholder="e.g. Spotify" value="${provider}" aria-label="Fixed Expense Provider">
                    </div>
                    <div>
                        <label class="form-label text-sm">Amount</label>
                        <input type="number" class="form-input text-sm fixed-expense-amount" placeholder="$ 50" value="${amount}" aria-label="Fixed Expense Amount">
                    </div>
                    <div>
                        <label class="form-label text-sm">Frequency 
                            <span class="text-slate-500 text-xs cursor-help" title="Weekly cost is calculated based on the original amount and frequency (e.g., Monthly / 4.33, Yearly / 52).">(i)</span>
                        </label>
                        <select class="form-input text-sm fixed-expense-freq form-select" aria-label="Fixed Expense Frequency">
                            ${['Weekly', 'Fortnightly', 'Monthly', 'Quarterly', 'Yearly'].map(f => `<option value="${f}" ${f === freq ? 'selected' : ''}>${f}</option>`).join('')}
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label class="form-label text-sm">Weekly Cost</label>
                        <span class="text-sm font-semibold text-slate-700 mt-1 fixed-expense-weekly-display"></span>
                        <button type="button" class="remove-fixed-expense-row btn-danger p-2 rounded-md w-full mt-2">Remove</button>
                    </div>
                `;

                container.appendChild(rowDiv);

                const amountInput = rowDiv.querySelector('.fixed-expense-amount');
                const freqSelect = rowDiv.querySelector('.fixed-expense-freq');
                
                amountInput.addEventListener('input', () => updateRowWeeklyDisplay(rowDiv));
                freqSelect.addEventListener('change', () => updateRowWeeklyDisplay(rowDiv));
                rowDiv.querySelector('.remove-fixed-expense-row').addEventListener('click', () => {
                    rowDiv.remove();
                });

                updateRowWeeklyDisplay(rowDiv); // Initial update for the new row
            }

            function populateFixedExpensesInputs(fixedExpenses) {
                const container = document.getElementById('fixed-expenses-inputs-container');
                container.innerHTML = ''; 
                if (fixedExpenses.length === 0) {
                    for (let i = 0; i < 3; i++) {
                        createFixedExpenseRow();
                    }
                } else {
                    fixedExpenses.forEach(expense => {
                        createFixedExpenseRow(expense.category, expense.provider, expense.amount, expense.freq);
                    });
                }
            }

            function updateCombinedIncomeInput() {
                const emmaIncome = parseFloat(document.getElementById('input-emma-income').value) || 0;
                const jordanIncome = parseFloat(document.getElementById('input-jordan-income').value) || 0;
                document.getElementById('input-combined-income').value = emmaIncome + jordanIncome;
            }

            function populateSavingsGoalInputs(savingsGoal) {
                // 'current' field value is set by processAndRenderData based on currentData.savingsGoal.current
                document.getElementById('input-savings-target').value = savingsGoal.target;
                document.getElementById('input-weekly-contribution').value = savingsGoal.weeklyContribution;
                document.getElementById('input-savings-start-date').value = savingsGoal.startDate || new Date().toISOString().split('T')[0];
            }

            function renderActualSavingsLog() {
                const list = document.getElementById('actual-savings-list');
                const noMessage = document.getElementById('no-actuals-message');
                list.innerHTML = ''; 

                if (!currentData.savingsGoal.actualSavingsLog || currentData.savingsGoal.actualSavingsLog.length === 0) {
                    noMessage.classList.remove('hidden');
                } else {
                    noMessage.classList.add('hidden');
                    const sortedLogs = [...currentData.savingsGoal.actualSavingsLog].sort((a, b) => new Date(b.date) - new Date(a.date)); 
                    sortedLogs.forEach((entry, index) => {
                        const li = document.createElement('li');
                        li.className = 'p-2 log-entry flex justify-between items-center';
                        li.innerHTML = `
                            <span>${formatDate(new Date(entry.date))}: ${formatCurrency(entry.amount)}</span>
                            <button type="button" class="delete-btn" data-log-type="savings" data-index="${index}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        `;
                        list.appendChild(li);
                    });
                }
            }

            function renderActualSavingsUsedLog() {
                const list = document.getElementById('actual-savings-used-list');
                const noMessage = document.getElementById('no-savings-used-message');
                list.innerHTML = ''; 

                if (!currentData.savingsGoal.actualSavingsUsedLog || currentData.savingsGoal.actualSavingsUsedLog.length === 0) {
                    noMessage.classList.remove('hidden');
                } else {
                    noMessage.classList.add('hidden');
                    const sortedLogs = [...currentData.savingsGoal.actualSavingsUsedLog].sort((a, b) => new Date(b.date) - new Date(a.date)); 
                    sortedLogs.forEach((entry, index) => {
                        const li = document.createElement('li');
                        li.className = 'p-2 log-entry flex justify-between items-center';
                        li.innerHTML = `
                            <span>${formatDate(new Date(entry.date))} - ${entry.reason}: ${formatCurrency(entry.amount)}</span>
                            <button type="button" class="delete-btn" data-log-type="savings-used" data-index="${index}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        `;
                        list.appendChild(li);
                    });
                }
            }

            // Function to render actual variable spending for the CURRENTLY VIEWED week
            function renderActualVariableSpendingLog(weekStartDate, isArchivedWeek, archivedSpendingLog = []) {
                const dataInputList = document.getElementById('actual-variable-spending-list');
                const weeklyBreakdownList = document.getElementById('weekly-actual-variable-spending-list'); 
                const noMessageDataInput = document.getElementById('no-actual-variable-spending-message');
                
                dataInputList.innerHTML = ''; 
                weeklyBreakdownList.innerHTML = ''; 

                let spendingToDisplay = [];
                if (isArchivedWeek) {
                    spendingToDisplay = archivedSpendingLog;
                } else {
                    const startOfWeek = window.getStartOfWeek(weekStartDate);
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6); // End of the week (Tuesday)
                    endOfWeek.setHours(23, 59, 59, 999); // Set to end of day

                    spendingToDisplay = (currentData.actualVariableSpendingLog || []).filter(entry => {
                        const entryDate = new Date(entry.date + 'T00:00:00'); // Ensure comparison is date-only
                        return entryDate >= startOfWeek && entryDate <= endOfWeek;
                    });
                }

                if (spendingToDisplay.length === 0) {
                    noMessageDataInput.classList.remove('hidden');
                } else {
                    noMessageDataInput.classList.add('hidden');
                    // Sort by date descending for display
                    const sortedLogs = [...spendingToDisplay].sort((a, b) => new Date(b.date) - new Date(a.date)); 
                    sortedLogs.forEach((entry, index) => {
                        const liDataInput = document.createElement('li');
                        liDataInput.className = 'p-2 log-entry flex justify-between items-center';
                        let textContent = `${formatDate(new Date(entry.date))}: ${entry.category} - ${formatCurrency(entry.amount)}`;
                        if (entry.description) {
                            textContent += ` (${entry.description})`;
                        }
                        liDataInput.innerHTML = `
                            <span>${textContent}</span>
                            ${!isArchivedWeek ? `<button type="button" class="delete-btn" data-log-type="variable-spending" data-index="${currentData.actualVariableSpendingLog.indexOf(entry)}">
                                <i class="fas fa-trash-alt"></i>
                            </button>` : ''}
                        `;
                        dataInputList.appendChild(liDataInput);

                        const liWeeklyBreakdown = document.createElement('li');
                        let breakdownTextContent = `${entry.category}: ${formatCurrency(entry.amount)}`;
                        if (entry.description) {
                            breakdownTextContent += ` (${entry.description})`;
                        }
                        liWeeklyBreakdown.textContent = breakdownTextContent;
                        weeklyBreakdownList.appendChild(liWeeklyBreakdown);
                    });
                }
            }

            // Render Variable Spending Summary (Budget vs. Actual) for the CURRENTLY VIEWED week
            function renderVariableSpendingSummary(weekStartDate, isArchivedWeek, archivedSpendingLog = [], archivedVariableBudget = []) {
                const tableBody = document.getElementById('variable-spending-summary-table');
                tableBody.innerHTML = '';

                let totalBudgeted = 0;
                let totalActual = 0;

                let variableExpensesToUse = isArchivedWeek ? archivedVariableBudget : currentData.variableExpenses;
                let actualSpendingToUse = isArchivedWeek ? archivedSpendingLog : currentData.actualVariableSpendingLog;

                const startOfWeek = window.getStartOfWeek(weekStartDate);
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);
                endOfWeek.setHours(23, 59, 59, 999);


                // Filter actual spending for the current week (or archived week)
                const filteredSpending = actualSpendingToUse.filter(entry => {
                    const entryDate = new Date(entry.date + 'T00:00:00');
                    return entryDate >= startOfWeek && entryDate <= endOfWeek;
                });

                // Create a map of actual spending by category for the filtered week
                const actualSpendingByCategory = filteredSpending.reduce((acc, item) => {
                    acc[item.category] = (acc[item.category] || 0) + item.amount;
                    return acc;
                }, {});

                // Iterate through budgeted categories to build the summary table
                variableExpensesToUse.forEach(budgetCategory => {
                    const budgetedAmount = budgetCategory.budget;
                    const actualAmount = actualSpendingByCategory[budgetCategory.name] || 0;
                    const difference = budgetedAmount - actualAmount;

                    const row = document.createElement('tr');
                    const differenceClass = difference < 0 ? 'text-overrun' : '';

                    row.innerHTML = `
                        <td class="p-3">${budgetCategory.name}</td>
                        <td class="p-3 text-right">
                            ${!isArchivedWeek ? `<input type="number" class="budgeted-variable-amount form-input text-right text-sm" data-category="${budgetCategory.name}" value="${budgetedAmount}" aria-label="${budgetCategory.name} Budgeted Amount">` : formatCurrency(budgetedAmount)}
                        </td>
                        <td class="p-3 text-right ${actualAmount > budgetedAmount ? 'text-overrun font-semibold' : ''}">${formatCurrency(actualAmount)}</td>
                        <td class="p-3 text-right ${differenceClass}">${formatCurrency(difference)}</td>
                    `;
                    tableBody.appendChild(row);

                    totalBudgeted += budgetedAmount;
                    totalActual += actualAmount;
                });

                // Add row for Previous Week Overspend/Underspend
                const prevWeekStart = new Date(startOfWeek);
                prevWeekStart.setDate(startOfWeek.getDate() - 7);
                const previousWeekSummary = currentData.historicalSummaries.find(summary => 
                    new Date(summary.date + 'T00:00:00').getTime() === prevWeekStart.getTime()
                );

                if (previousWeekSummary && typeof previousWeekSummary.netPosition !== 'undefined') {
                    const prevNetPosition = previousWeekSummary.netPosition;
                    let label = '';
                    let value = 0;
                    let valueClass = '';

                    if (prevNetPosition < 0) {
                        label = 'Previous Week Overspend';
                        value = Math.abs(prevNetPosition);
                        valueClass = 'text-overrun';
                    } else if (prevNetPosition > 0) {
                        label = 'Previous Week Underspend';
                        value = prevNetPosition;
                        valueClass = 'text-green-600';
                    }

                    if (value !== 0) {
                        const prevWeekRow = document.createElement('tr');
                        prevWeekRow.className = 'border-t border-slate-200';
                        prevWeekRow.innerHTML = `
                            <td class="p-3 font-semibold">${label}</td>
                            <td class="p-3 text-right"></td>
                            <td class="p-3 text-right"></td>
                            <td class="p-3 text-right font-semibold ${valueClass}">${formatCurrency(value)}</td>
                        `;
                        tableBody.appendChild(prevWeekRow);
                    }
                }


                document.getElementById('total-variable-budgeted').textContent = formatCurrency(totalBudgeted);
                document.getElementById('total-variable-actual').textContent = formatCurrency(totalActual);
                document.getElementById('total-variable-difference').textContent = formatCurrency(totalBudgeted - totalActual);

                const totalActualElement = document.getElementById('combined-actual-variable-spending');
                
                if (totalActual > totalBudgeted) {
                    totalActualElement.classList.add('text-overrun');
                } else {
                    totalActualElement.classList.remove('text-overrun');
                }

                // Only attach event listeners if it's not an archived week
                if (!isArchivedWeek) {
                    document.querySelectorAll('.budgeted-variable-amount').forEach(input => {
                        input.addEventListener('input', (event) => {
                            const categoryName = event.target.dataset.category;
                            const newBudget = parseFloat(event.target.value) || 0;

                            const categoryIndex = currentData.variableExpenses.findIndex(cat => cat.name === categoryName);
                            if (categoryIndex !== -1) {
                                currentData.variableExpenses[categoryIndex].budget = newBudget;
                                processAndRenderData(currentData, currentViewDate); // Re-render with current view date
                                saveData(currentData);
                            }
                        });
                    });
                }
            }

            // Function to populate the variable expense category dropdown
            function populateVariableCategoryDropdown() {
                const select = document.getElementById('input-actual-variable-category');
                const trendSelect = document.getElementById('trend-category-select');
                
                select.innerHTML = '<option value="">Select Category</option>'; // Clear existing options
                trendSelect.innerHTML = '<option value="">All Categories</option>';

                currentData.variableExpenses.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.name;
                    option.textContent = category.name;
                    select.appendChild(option);

                    const trendOption = document.createElement('option');
                    trendOption.value = category.name;
                    trendOption.textContent = category.name;
                    trendSelect.appendChild(trendOption);
                });
            }

            // Function to render variable categories in the management section
            function renderVariableCategoriesManagement() {
                const ul = document.getElementById('variable-categories-ul');
                const noMessage = document.getElementById('no-variable-categories-message');
                ul.innerHTML = '';

                if (!currentData.variableExpenses || currentData.variableExpenses.length === 0) {
                    noMessage.classList.remove('hidden');
                } else {
                    noMessage.classList.add('hidden');
                    currentData.variableExpenses.forEach(category => {
                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center p-2 log-entry';
                        li.innerHTML = `
                            <span>${category.name}</span>
                            <button type="button" class="remove-variable-category-button btn-danger px-2 py-1 text-xs" data-category="${category.name}">Remove</button>
                        `;
                        ul.appendChild(li);
                    });

                    // Attach event listeners for remove buttons
                    ul.querySelectorAll('.remove-variable-category-button').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const categoryToRemove = event.target.dataset.category;
                            currentData.variableExpenses = currentData.variableExpenses.filter(cat => cat.name !== categoryToRemove);
                            // Also remove any actual spending associated with this category to prevent errors
                            currentData.actualVariableSpendingLog = currentData.actualVariableSpendingLog.filter(log => log.category !== categoryToRemove);
                            processAndRenderData(currentData, currentViewDate); // Re-render with current view date
                            saveData(currentData);
                            showToast(`Category "${categoryToRemove}" removed.`, 'info');
                        });
                    });
                }
            }


            function parseInputData() {
                const parsed = {};

                parsed.income = {
                    emma: parseFloat(document.getElementById('input-emma-income').value) || 0,
                    jordan: parseFloat(document.getElementById('input-jordan-income').value) || 0
                };
                parsed.income.combined = parsed.income.emma + parsed.income.jordan;

                parsed.savingsGoal = {
                    name: 'Custom Goal', 
                    startDate: document.getElementById('input-savings-start-date').value || new Date().toISOString().split('T')[0],
                    current: currentData.savingsGoal.current, // Use the current value from currentData
                    target: parseFloat(document.getElementById('input-savings-target').value) || 0,
                    weeklyContribution: parseFloat(document.getElementById('input-weekly-contribution').value) || 0,
                    actualSavingsLog: currentData.savingsGoal.actualSavingsLog || [],
                    actualSavingsUsedLog: currentData.savingsGoal.actualSavingsUsedLog || [],
                    milestonesReached: currentData.savingsGoal.milestonesReached || [] // Preserve milestones
                };

                parsed.fixedExpenses = [];
                document.querySelectorAll('.fixed-expense-row').forEach(rowDiv => {
                    const categoryInput = rowDiv.querySelector('.fixed-expense-category'); 
                    const providerInput = rowDiv.querySelector('.fixed-expense-provider'); 
                    const amountInput = rowDiv.querySelector('.fixed-expense-amount');
                    const freqSelect = rowDiv.querySelector('.fixed-expense-freq');

                    const category = categoryInput ? categoryInput.value.trim() : ''; 
                    const provider = providerInput ? providerInput.value.trim() : ''; 
                    const amount = amountInput ? parseFloat(amountInput.value) : NaN;
                    const freq = freqSelect ? freqSelect.value : 'Weekly';

                    if (category && provider && !isNaN(amount) && amount >= 0) { 
                        parsed.fixedExpenses.push({ category, provider, amount, freq }); 
                    } else if (category || provider || !isNaN(amount)) { 
                        console.warn('Skipping partially filled/invalid fixed expense row:', { category, provider, amount, freq });
                    }
                });

                // Variable expenses are now managed via the dedicated UI, so we just pass the current state
                parsed.variableExpenses = currentData.variableExpenses; 
                parsed.actualVariableSpendingLog = currentData.actualVariableSpendingLog || [];
                parsed.historicalSummaries = currentData.historicalSummaries || [];
                parsed.notificationEmail = document.getElementById('input-notification-email').value.trim();

                return parsed;
            }

            // Function to enable/disable inputs and buttons based on whether the week is archived
            function toggleInputsForArchivedWeek(isArchived) {
                const inputsAndButtons = [
                    document.getElementById('input-actual-variable-category'),
                    document.getElementById('input-actual-variable-amount'),
                    document.getElementById('input-actual-variable-description'),
                    document.getElementById('input-actual-variable-date'),
                    document.getElementById('add-actual-variable-spending-button'),
                    document.getElementById('add-fixed-expense-button'),
                    document.getElementById('update-dashboard-button'),
                    document.getElementById('new-variable-category-name'),
                    document.getElementById('add-variable-category-button'),
                    document.getElementById('input-weekly-actual-amount'),
                    document.getElementById('input-weekly-actual-date'),
                    document.getElementById('add-actual-saving-button'),
                    document.getElementById('input-savings-used-amount'),
                    document.getElementById('input-savings-used-reason'),
                    document.getElementById('input-savings-used-date'),
                    document.getElementById('add-savings-used-button'),
                    document.getElementById('input-emma-income'),
                    document.getElementById('input-jordan-income'),
                    document.getElementById('input-savings-target'),
                    document.getElementById('input-weekly-contribution'),
                    document.getElementById('input-savings-start-date'),
                    document.getElementById('input-notification-email'), // New: Notification email input
                    // The archive button itself is handled separately for text change
                ];

                inputsAndButtons.forEach(element => {
                    if (element) {
                        element.disabled = isArchived;
                        if (isArchived) {
                            element.classList.add('opacity-50', 'cursor-not-allowed');
                        } else {
                            element.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                    }
                });

                // Handle dynamically created fixed expense rows
                document.querySelectorAll('.fixed-expense-row input, .fixed-expense-row select, .fixed-expense-row button').forEach(element => {
                    element.disabled = isArchived;
                    if (isArchived) {
                        element.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        element.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                });

                // Handle dynamically created variable category remove buttons
                document.querySelectorAll('.remove-variable-category-button').forEach(element => {
                    element.disabled = isArchived;
                    if (isArchived) {
                        element.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        element.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                });

                // Handle budgeted variable amount inputs (these are created dynamically)
                document.querySelectorAll('.budgeted-variable-amount').forEach(element => {
                    element.disabled = isArchived;
                    if (isArchived) {
                        element.classList.add('opacity-50', 'cursor-not-allowed');
                        element.readOnly = true; // Make it truly read-only
                    } else {
                        element.classList.remove('opacity-50', 'cursor-not-allowed');
                        element.readOnly = false;
                    }
                });

                // Special handling for the archive button text
                const archiveBtn = document.getElementById('archive-week-button');
                if (archiveBtn) {
                    if (isArchived) {
                        archiveBtn.textContent = 'Week Archived (Read-Only)';
                        archiveBtn.classList.remove('btn-primary');
                        archiveBtn.classList.add('btn-secondary'); // Change style to indicate disabled/read-only
                    } else {
                        archiveBtn.textContent = 'Archive Current Week & Start New';
                        archiveBtn.classList.remove('btn-secondary');
                        archiveBtn.classList.add('btn-primary');
                    }
                }
            }


            // Main rendering function, now takes a view date
            function processAndRenderData(dataToUse, viewDate) {
                console.log("Starting processAndRenderData...");
                currentData = dataToUse; 
                currentViewDate = viewDate; // Update the global view date

                // Set the week selector input to the start of the currently viewed week
                const startOfViewWeek = window.getStartOfWeek(currentViewDate);
                document.getElementById('week-selector').value = window.toYYYYMMDD(startOfViewWeek);

                // Check if the current view week is an archived week
                const archivedSummary = currentData.historicalSummaries.find(summary => {
                    const summaryDate = new Date(summary.date + 'T00:00:00');
                    return summaryDate.getTime() === startOfViewWeek.getTime();
                });
                const isCurrentWeekArchived = !!archivedSummary;

                // Directly use currentData.savingsGoal.current for the input field
                document.getElementById('input-savings-current').value = currentData.savingsGoal.current; 

                const processed = {
                    fixedExpensesWeekly: currentData.fixedExpenses.map(e => ({
                        category: e.category, 
                        provider: e.provider, 
                        weekly: getWeeklyAmount(e.amount, e.freq)
                    })),
                    get totalFixedWeekly() { return this.fixedExpensesWeekly.reduce((sum, e) => sum + e.weekly, 0); },
                    get totalVariableBudget() { 
                        // If archived week, use its budgeted amount, otherwise use current
                        return isCurrentWeekArchived && archivedSummary ? archivedSummary.totalVariableBudget : currentData.variableExpenses.reduce((sum, e) => sum + e.budget, 0); 
                    }, 
                };

                // Filter actual variable spending for the current view week
                const actualVariableSpendingForViewWeek = isCurrentWeekArchived && archivedSummary ? 
                                                            archivedSummary.actualVariableSpendingLog.reduce((sum, e) => sum + e.amount, 0) :
                                                            (currentData.actualVariableSpendingLog || []).filter(entry => {
                                                                const entryDate = new Date(entry.date + 'T00:00:00');
                                                                const startOfWeek = window.getStartOfWeek(currentViewDate);
                                                                const endOfWeek = new Date(startOfWeek);
                                                                endOfWeek.setDate(startOfWeek.getDate() + 6);
                                                                endOfWeek.setHours(23, 59, 59, 999);
                                                                return entryDate >= startOfWeek && entryDate <= endOfWeek;
                                                            }).reduce((sum, e) => sum + e.amount, 0);
                processed.totalActualVariableSpending = actualVariableSpendingForViewWeek;
                processed.totalExpensesWeekly = processed.totalFixedWeekly + processed.totalActualVariableSpending;


                // Calculate carry-over from the *immediately preceding* archived week
                let carryOver = 0;
                const prevWeekStartDate = new Date(startOfViewWeek);
                prevWeekStartDate.setDate(startOfViewWeek.getDate() - 7);
                const previousWeekSummary = currentData.historicalSummaries.find(summary => 
                    new Date(summary.date + 'T00:00:00').getTime() === prevWeekStartDate.getTime()
                );

                if (previousWeekSummary) {
                    carryOver = previousWeekSummary.netPosition;
                }
                
                const combinedCarryOverElement = document.getElementById('combined-carry-over');
                if (combinedCarryOverElement) {
                    combinedCarryOverElement.textContent = formatCurrency(carryOver);
                } else {
                    console.error("Element with ID 'combined-carry-over' not found.");
                }


                // Update Key Metrics
                document.getElementById('metric-income').textContent = formatCurrency(currentData.income.combined);
                document.getElementById('metric-expenses').textContent = formatCurrency(processed.totalFixedWeekly + processed.totalActualVariableSpending); 
                document.getElementById('metric-savings').textContent = formatCurrency(currentData.savingsGoal.weeklyContribution);
                
                const netWeeklyPosition = currentData.income.combined - processed.totalFixedWeekly - processed.totalActualVariableSpending - currentData.savingsGoal.weeklyContribution + carryOver;
                const metricNetElement = document.getElementById('metric-net');
                metricNetElement.textContent = formatCurrency(netWeeklyPosition);
                metricNetElement.classList.remove('text-green-600', 'text-red-600', 'text-slate-700');
                if (netWeeklyPosition > 0) {
                    metricNetElement.classList.add('text-green-600');
                } else if (netWeeklyPosition < 0) {
                    metricNetElement.classList.add('text-red-600');
                } else {
                    metricNetElement.classList.add('text-slate-700');
                }


                // Update Combined Weekly Summary
                document.getElementById('combined-net-pay').textContent = formatCurrency(currentData.income.combined);
                document.getElementById('combined-fixed-expenses').textContent = formatCurrency(processed.totalFixedWeekly);
                document.getElementById('combined-actual-variable-spending').textContent = formatCurrency(processed.totalActualVariableSpending);
                document.getElementById('combined-savings-contribution').textContent = formatCurrency(currentData.savingsGoal.weeklyContribution);
                
                const combinedDisposable = currentData.income.combined - processed.totalFixedWeekly - processed.totalActualVariableSpending - currentData.savingsGoal.weeklyContribution + carryOver;
                document.getElementById('combined-disposable').textContent = formatCurrency(combinedDisposable);

                // Update Combined Weekly Chart
                updateCombinedWeeklySummaryBarChart('combinedWeeklyChart', 
                    ['Net Pay', 'Fixed Expenses', 'Actual Variable Spending', 'Savings', 'Disposable'],
                    [currentData.income.combined, processed.totalFixedWeekly, processed.totalActualVariableSpending, currentData.savingsGoal.weeklyContribution, Math.max(0, combinedDisposable)],
                    ['#22c55e', '#ef4444', '#f97316', '#3b82f6', '#64748b'] 
                );

                const tableBody = document.getElementById('fixed-expenses-table');
                tableBody.innerHTML = '';
                processed.fixedExpensesWeekly
                    .sort((a,b) => b.weekly - a.weekly)
                    .forEach(e => {
                        const row = `
                            <tr class="border-b border-slate-100">
                                <td class="p-3">${e.category}</td>
                                <td class="p-3">${e.provider}</td>
                                <td class="p-3 text-right font-semibold">${formatCurrency(e.weekly)}</td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });

                const allExpenseCategories = [
                    ...processed.fixedExpensesWeekly.map(e => ({ name: e.category, weekly: e.weekly })), 
                    // Use actual variable spending for the VIEWED week for this chart
                    ...(isCurrentWeekArchived && archivedSummary ? archivedSummary.actualVariableSpendingLog : currentData.actualVariableSpendingLog).filter(entry => {
                        const entryDate = new Date(entry.date + 'T00:00:00');
                        const startOfWeek = window.getStartOfWeek(currentViewDate);
                        const endOfWeek = new Date(startOfWeek);
                        endOfWeek.setDate(startOfWeek.getDate() + 6);
                        endOfWeek.setHours(23, 59, 59, 999);
                        return entryDate >= startOfWeek && entryDate <= endOfWeek;
                    }).map(v => ({ name: v.category, weekly: v.amount }))
                ];
                const aggregatedCategories = allExpenseCategories.reduce((acc, item) => {
                    acc[item.name] = (acc[item.name] || 0) + item.weekly;
                    return acc;
                }, {});

                const expenseCategoriesForChart = Object.entries(aggregatedCategories)
                    .map(([name, weekly]) => ({ name, weekly }))
                    .filter(e => e.weekly && e.weekly > 0)
                    .sort((a, b) => b.weekly - a.weekly) 
                    .slice(0, 7); 

                updateBarChart('expensesBarChart', expenseCategoriesForChart.map(e => e.name), expenseCategoriesForChart.map(e => e.weekly));

                const { current, target, weeklyContribution, startDate } = currentData.savingsGoal;
                document.getElementById('savings-current-display').textContent = formatCurrency(current); 
                document.getElementById('savings-target-display').textContent = formatCurrency(target); 

                const progress = target > 0 ? (current / target) * 100 : 0;
                const remaining = Math.max(0, target - current);
                const weeksNeeded = weeklyContribution > 0 ? remaining / weeklyContribution : (remaining > 0 ? Infinity : 0);
                
                const eta = new Date(); 
                if (isFinite(weeksNeeded)) {
                    eta.setDate(eta.getDate() + (weeksNeeded * 7));
                } else {
                    eta.setTime(0); 
                }

                document.getElementById('progress-bar').style.width = `${Math.min(100, Math.round(progress))}%`;
                document.getElementById('progress-bar').textContent = `${Math.round(progress)}%`;
                document.getElementById('savings-remaining').textContent = formatCurrency(remaining);
                document.getElementById('savings-eta').textContent = isFinite(weeksNeeded) ? formatDate(eta) : 'N/A (Adjust Contribution)';
                
                const projectionLabels = [];
                const projectionData = [];

                const chartStartDate = new Date();
                projectionLabels.push(formatDate(chartStartDate));
                projectionData.push(current); 

                let weekCount = 0;
                let currentProjBalance = current;
                let currentProjDate = new Date(chartStartDate); 

                const maxWeeksToProject = 52 * 2; 

                while (weekCount < maxWeeksToProject && (currentProjBalance < target * 1.1 || weekCount < 20)) {
                    currentProjBalance += weeklyContribution;
                    currentProjDate.setDate(currentProjDate.getDate() + 7);
                    
                    projectionLabels.push(formatDate(currentProjDate));
                    projectionData.push(currentProjBalance);
                    
                    weekCount++;
                }

                updateLineChart('savingsLineChart', projectionLabels, projectionData);

                // Check for savings milestones
                const milestones = [10000, 20000, 30000]; // Example milestones
                let newMilestoneReached = false;
                milestones.forEach(milestone => {
                    if (current >= milestone && !currentData.savingsGoal.milestonesReached.includes(milestone)) {
                        currentData.savingsGoal.milestonesReached.push(milestone);
                        showToast(`🎉 Congratulations! You've reached $${milestone} in savings!`, 'success');
                        newMilestoneReached = true;
                    }
                });
                if (newMilestoneReached) {
                    saveData(currentData);
                }

                // Call new rendering functions for new features
                renderActualVariableSpendingLog(currentViewDate, isCurrentWeekArchived, archivedSummary ? archivedSummary.actualVariableSpendingLog : []); // Pass archived log
                renderVariableSpendingSummary(currentViewDate, isCurrentWeekArchived, archivedSummary ? archivedSummary.actualVariableSpendingLog : [], archivedSummary ? archivedSummary.variableExpensesAtArchive : []); // Pass archived log and budget
                updateHistoricalChart(currentData.historicalSummaries);
                populateVariableCategoryDropdown(); // Update dropdown with current categories
                renderVariableCategoriesManagement(); // Update management list
                updateExpenseTrendChart(currentData.historicalSummaries, document.getElementById('trend-category-select').value); // Update trend chart
                
                // Toggle inputs based on whether the week is archived
                toggleInputsForArchivedWeek(isCurrentWeekArchived);

                // --- Notification Logic ---
                const today = new Date();
                const currentWeekStart = window.toYYYYMMDD(window.getStartOfWeek(today));
                const lastNetPositionNotification = JSON.parse(localStorage.getItem('lastNetPositionNotification')) || {};
                const lastWednesdayReminder = localStorage.getItem('lastWednesdayReminder');

                // Net Weekly Position Notifications
                if (window.toYYYYMMDD(startOfViewWeek) === currentWeekStart && !isCurrentWeekArchived) { // Only for current, unarchived week
                    if (netWeeklyPosition >= 50 && (lastNetPositionNotification.value < 50 || lastNetPositionNotification.week !== currentWeekStart)) {
                        showToast(`Great job! Your Net Weekly Position is ${formatCurrency(netWeeklyPosition)}!`, 'success');
                        localStorage.setItem('lastNetPositionNotification', JSON.stringify({ value: netWeeklyPosition, week: currentWeekStart }));
                    } else if (netWeeklyPosition <= 0 && (lastNetPositionNotification.value > 0 || lastNetPositionNotification.week !== currentWeekStart)) {
                        showToast(`Heads up! Your Net Weekly Position is ${formatCurrency(netWeeklyPosition)}. Consider adjusting spending.`, 'error');
                        localStorage.setItem('lastNetPositionNotification', JSON.stringify({ value: netWeeklyPosition, week: currentWeekStart }));
                    }
                } else if (window.toYYYYMMDD(startOfViewWeek) !== currentWeekStart && lastNetPositionNotification.week === currentWeekStart) {
                    // Reset notification for a new week if we've navigated away from the current one
                    localStorage.removeItem('lastNetPositionNotification');
                }


                // Wednesday Morning Reminders (only if viewing the actual current week)
                if (today.getDay() === 3 && window.toYYYYMMDD(startOfViewWeek) === currentWeekStart) { // Wednesday (3)
                    if (lastWednesdayReminder !== window.toYYYYMMDD(today)) {
                        showToast("Reminder: It's Wednesday! Don't forget to archive the previous week and update your savings goals!", 'info', 7000);
                        localStorage.setItem('lastWednesdayReminder', window.toYYYYMMDD(today));
                    }
                } else if (today.getDay() !== 3 && lastWednesdayReminder === window.toYYYYMMDD(today)) {
                    // Clear the reminder flag if it's no longer Wednesday
                    localStorage.removeItem('lastWednesdayReminder');
                }


                console.log("Finished processAndRenderData.");
            }

            const chartDefaults = {
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        enabled: true,
                        backgroundColor: '#1e293b',
                        titleColor: '#cbd5e1',
                        bodyColor: '#f1f5f9',
                        padding: 10,
                        cornerRadius: 6,
                    }
                },
                responsive: true,
                maintainAspectRatio: false,
            };

            function updateCombinedWeeklySummaryBarChart(canvasId, labels, data, colors) {
                const ctx = document.getElementById(canvasId).getContext('2d');
                if (!ctx) {
                    console.error('Canvas context not found for:', canvasId);
                    return;
                }
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js library not loaded. Cannot create chart.');
                    return;
                }

                if (combinedWeeklyChart) { 
                    combinedWeeklyChart.destroy();
                }

                try {
                    combinedWeeklyChart = new Chart(ctx, { 
                        type: 'bar', 
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Amount',
                                data: data,
                                backgroundColor: colors, 
                                borderRadius: 4,
                            }]
                        },
                        options: {
                            ...chartDefaults,
                            indexAxis: 'y', 
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: (value) => formatCurrency(value),
                                    }
                                },
                                y: {
                                    autoSkip: false,
                                    minRotation: 0,
                                    maxRotation: 0
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error creating/updating combined weekly summary bar chart:', canvasId, error);
                }
            }
            
            function updateBarChart(canvasId, labels, data) {
                const ctx = document.getElementById(canvasId).getContext('2d');
                if (!ctx) {
                    console.error('Canvas context not found for:', canvasId);
                    return;
                }
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js library not loaded. Cannot create chart.');
                    return;
                }

                if (expensesBarChart) {
                    expensesBarChart.destroy();
                }

                try {
                    expensesBarChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Weekly Cost',
                                data: data,
                                backgroundColor: '#4f46e5',
                                borderRadius: 4,
                            }]
                        },
                        options: {
                            ...chartDefaults,
                            indexAxis: 'y',
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: (value) => formatCurrency(value),
                                    }
                                },
                                y: {
                                    ticks: {
                                        autoSkip: false,
                                        minRotation: 0,
                                        maxRotation: 0,
                                        callback: function(value, index, values) {
                                            const label = this.getLabelForValue(value);
                                            const maxLength = 16;
                                            if (label.length > maxLength) {
                                                return label.match(new RegExp('.{1,' + maxLength + '}', 'g'));
                                            }
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error creating/updating bar chart:', canvasId, error);
                }
            }

            function updateLineChart(canvasId, labels, data) {
                const ctx = document.getElementById(canvasId).getContext('2d');
                if (!ctx) {
                    console.error('Canvas context not found for:', canvasId);
                    return;
                }
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js library not loaded. Cannot create chart.');
                    return;
                }

                if (savingsLineChart) {
                    savingsLineChart.destroy();
                }

                try {
                    savingsLineChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Projected Balance',
                                data: data,
                                borderColor: '#4f46e5',
                                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                                fill: true,
                                tension: 0.1,
                                pointRadius: 0
                            }]
                        },
                        options: {
                            ...chartDefaults,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: (value) => formatCurrency(value),
                                    }
                                },
                                x: {
                                    ticks: {
                                        autoSkip: true,
                                        minRotation: 0,
                                        maxRotation: 0,
                                        maxTicksLimit: 6
                                    }
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error creating/updating line chart:', canvasId, error);
                }
            }

            // Update Historical Net Position Chart
            function updateHistoricalChart(historicalData) {
                const ctx = document.getElementById('historicalNetPositionChart').getContext('2d');
                if (!ctx) {
                    console.error('Canvas context not found for historicalNetPositionChart.');
                    return;
                }
                if (historicalNetPositionChart) {
                    historicalNetPositionChart.destroy();
                }

                const labels = historicalData.map(item => formatDate(item.date));
                const data = historicalData.map(item => item.netPosition);

                historicalNetPositionChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Net Position',
                            data: data,
                            borderColor: '#3b82f6', // blue-500
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.1,
                            pointRadius: 3,
                            pointBackgroundColor: '#3b82f6',
                            pointBorderColor: '#fff',
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        ...chartDefaults,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => formatCurrency(value)
                                }
                            },
                            x: {
                                ticks: {
                                    autoSkip: true,
                                    minRotation: 0,
                                    maxRotation: 45,
                                    maxTicksLimit: 7
                                }
                            }
                        }
                    }
                });
            }

            // New: Update Expense Trend Chart
            function updateExpenseTrendChart(historicalData, selectedCategory) {
                const ctx = document.getElementById('expenseTrendChart').getContext('2d');
                if (!ctx) {
                    console.error('Canvas context not found for expenseTrendChart.');
                    return;
                }
                if (expenseTrendChart) {
                    expenseTrendChart.destroy();
                }

                const labels = historicalData.map(item => formatDate(item.date));
                let data = [];

                if (selectedCategory && selectedCategory !== "") {
                    // Filter for a specific category
                    data = historicalData.map(item => {
                        return item.actualVariableSpendingBreakdown ? (item.actualVariableSpendingBreakdown[selectedCategory] || 0) : 0;
                    });
                } else {
                    // Sum all categories for "All Categories"
                    data = historicalData.map(item => {
                        if (item.actualVariableSpendingBreakdown) {
                            return Object.values(item.actualVariableSpendingBreakdown).reduce((sum, val) => sum + val, 0);
                        }
                        return 0;
                    });
                }

                expenseTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: selectedCategory ? `${selectedCategory} Spending` : 'Total Variable Spending',
                            data: data,
                            borderColor: '#f97316', // orange-500
                            backgroundColor: 'rgba(249, 115, 22, 0.1)',
                            fill: true,
                            tension: 0.1,
                            pointRadius: 3,
                            pointBackgroundColor: '#f97316',
                            pointBorderColor: '#fff',
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        ...chartDefaults,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => formatCurrency(value)
                                }
                            },
                            x: {
                                ticks: {
                                    autoSkip: true,
                                    minRotation: 0,
                                    maxRotation: 45,
                                    maxTicksLimit: 7
                                }
                            }
                        }
                    }
                });
            }


            // Function to attach all event listeners that are dependent on Firebase
            function attachFirebaseDependentEventListeners() {
                console.log("Attaching Firebase dependent event listeners.");
                document.getElementById('add-fixed-expense-button').addEventListener('click', () => {
                    createFixedExpenseRow('', '', '', 'Weekly'); 
                    saveData(currentData);
                    showToast('New fixed expense row added.', 'info');
                });

                document.getElementById('add-actual-saving-button').addEventListener('click', () => {
                    const actualAmountInput = document.getElementById('input-weekly-actual-amount');
                    const actualDateInput = document.getElementById('input-weekly-actual-date');
                    
                    const amount = parseFloat(actualAmountInput.value);
                    const date = actualDateInput.value || new Date().toISOString().split('T')[0];

                    if (!isNaN(amount) && amount > 0) {
                        currentData.savingsGoal.actualSavingsLog.push({ date: date, amount: amount });
                        currentData.savingsGoal.actualSavingsLog.sort((a, b) => new Date(a.date) - new Date(b.date));
                        currentData.savingsGoal.current += amount; 
                        
                        actualAmountInput.value = '';
                        actualDateInput.value = '';

                        processAndRenderData(currentData, currentViewDate); // Re-render with current view date
                        renderActualSavingsLog(); 
                        saveData(currentData);
                        showToast('Saving logged successfully!', 'success');
                    } else {
                        showToast('Please enter a positive amount for saving.', 'error');
                        console.warn('Invalid actual saving amount entered. Please enter a positive number.');
                    }
                });

                // Event delegation for deleting savings log entries
                document.getElementById('actual-savings-list').addEventListener('click', (event) => {
                    if (event.target.closest('.delete-btn')) {
                        const button = event.target.closest('.delete-btn');
                        const index = parseInt(button.dataset.index);
                        if (!isNaN(index) && index >= 0 && index < currentData.savingsGoal.actualSavingsLog.length) {
                            const deletedEntry = currentData.savingsGoal.actualSavingsLog.splice(index, 1)[0];
                            currentData.savingsGoal.current -= deletedEntry.amount; // Deduct the amount from current savings
                            processAndRenderData(currentData, currentViewDate);
                            renderActualSavingsLog();
                            saveData(currentData);
                            showToast('Saving entry deleted.', 'info');
                        }
                    }
                });

                // Event delegation for deleting savings used log entries
                document.getElementById('actual-savings-used-log-display').addEventListener('click', (event) => {
                    if (event.target.closest('.delete-btn')) {
                        const button = event.target.closest('.delete-btn');
                        const index = parseInt(button.dataset.index);
                        if (!isNaN(index) && index >= 0 && index < currentData.savingsGoal.actualSavingsUsedLog.length) {
                            const deletedEntry = currentData.savingsGoal.actualSavingsUsedLog.splice(index, 1)[0];
                            currentData.savingsGoal.current += deletedEntry.amount; // Add back the amount to current savings
                            processAndRenderData(currentData, currentViewDate);
                            renderActualSavingsUsedLog();
                            saveData(currentData);
                            showToast('Savings used entry deleted.', 'info');
                        }
                    }
                });

                const categorySelect = document.getElementById('input-actual-variable-category');
                const descriptionInput = document.getElementById('input-actual-variable-description'); 
                const dateInput = document.getElementById('input-actual-variable-date'); // Get the date input element

                document.getElementById('add-actual-variable-spending-button').addEventListener('click', () => {
                    const category = categorySelect.value.trim();
                    const amountInput = document.getElementById('input-actual-variable-amount');
                    const amount = parseFloat(amountInput.value);
                    const date = dateInput.value || window.toYYYYMMDD(new Date()); // Default to today's date if not specified
                    const description = descriptionInput.value.trim();

                    console.log('Attempting to log spending:', { category, amount, date, description });

                    if (category && !isNaN(amount) && amount > 0) {
                        currentData.actualVariableSpendingLog.push({ category: category, amount: amount, date: date, description: description });
                        currentData.actualVariableSpendingLog.sort((a, b) => new Date(b.date) - new Date(a.date));

                        categorySelect.value = '';
                        amountInput.value = '';
                        dateInput.value = window.toYYYYMMDD(new Date()); // Reset to today's date after logging
                        descriptionInput.value = ''; 

                        processAndRenderData(currentData, currentViewDate); // Re-render with current view date
                        saveData(currentData);
                        showToast('Spending logged successfully!', 'success');
                    } else {
                        showToast('Please select a category and enter a positive amount.', 'error');
                        console.warn('Invalid actual variable spending entry. Please fill in category and a positive amount.');
                    }
                });

                // Event delegation for deleting variable spending log entries
                document.getElementById('actual-variable-spending-log-display').addEventListener('click', (event) => {
                    if (event.target.closest('.delete-btn')) {
                        const button = event.target.closest('.delete-btn');
                        const index = parseInt(button.dataset.index);
                        if (!isNaN(index) && index >= 0 && index < currentData.actualVariableSpendingLog.length) {
                            currentData.actualVariableSpendingLog.splice(index, 1);
                            processAndRenderData(currentData, currentViewDate);
                            saveData(currentData);
                            showToast('Spending entry deleted.', 'info');
                        }
                    }
                });

                document.getElementById('input-emma-income').addEventListener('input', () => {
                    updateCombinedIncomeInput();
                    saveData(currentData);
                });
                document.getElementById('input-jordan-income').addEventListener('input', () => {
                    updateCombinedIncomeInput();
                    saveData(currentData);
                });
                
                document.getElementById('update-dashboard-button').addEventListener('click', () => {
                    console.log('Update Dashboard button clicked');
                    const newData = parseInputData();
                    currentData = newData; 
                    processAndRenderData(currentData, currentViewDate); // Re-render with current view date
                    saveData(currentData);
                    showToast('Dashboard updated successfully!', 'success');
                });

                // Archive Week button event listener
                const archiveButton = document.getElementById('archive-week-button');
                const confirmModal = document.getElementById('confirmation-modal');
                const confirmModalBtn = document.getElementById('confirm-archive-modal-btn');
                const cancelModalBtn = document.getElementById('cancel-archive-modal-btn');

                archiveButton.addEventListener('click', () => {
                    confirmModal.classList.remove('hidden'); // Show the modal
                });

                confirmModalBtn.addEventListener('click', () => {
                    confirmModal.classList.add('hidden'); // Hide modal
                    archiveCurrentWeek(currentViewDate); // Call archive function
                    showToast('Week archived and new week started!', 'success');
                });

                cancelModalBtn.addEventListener('click', () => {
                    confirmModal.classList.add('hidden'); // Hide modal
                    showToast('Archive cancelled.', 'info');
                });

                // Add Variable Category button
                document.getElementById('add-variable-category-button').addEventListener('click', () => {
                    const newCategoryInput = document.getElementById('new-variable-category-name');
                    const newCategoryName = newCategoryInput.value.trim();

                    if (newCategoryName) {
                        // Check if category already exists
                        if (currentData.variableExpenses.some(cat => cat.name.toLowerCase() === newCategoryName.toLowerCase())) {
                            showToast('Category already exists!', 'error');
                            return;
                        }
                        currentData.variableExpenses.push({ name: newCategoryName, budget: 0 });
                        newCategoryInput.value = '';
                        processAndRenderData(currentData, currentViewDate); // Re-render with current view date
                        saveData(currentData);
                        showToast(`Category "${newCategoryName}" added!`, 'success');
                    } else {
                        showToast('Please enter a category name.', 'error');
                    }
                });

                // Export Data button
                document.getElementById('export-data-button').addEventListener('click', () => {
                    const dataStr = JSON.stringify(currentData, null, 2); // Pretty print JSON
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'financial_dashboard_data.json';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showToast('Data exported successfully!', 'success');
                });

                // LLM Integration: Get Financial Tips button
                document.getElementById('get-financial-tips-button').addEventListener('click', async () => {
                    const tipsOutputDiv = document.getElementById('financial-tips-output');
                    const llmSpinner = document.getElementById('llm-spinner');

                    tipsOutputDiv.classList.add('hidden'); // Hide previous tips
                    llmSpinner.classList.remove('hidden'); // Show spinner

                    try {
                        // Prepare data for the prompt
                        const income = currentData.income.combined;
                        const totalFixedExpenses = currentData.fixedExpenses.reduce((sum, e) => sum + getWeeklyAmount(e.amount, e.freq), 0);
                        
                        // Use actual variable spending for the CURRENTLY VIEWED week for the prompt
                        const startOfViewWeek = window.getStartOfWeek(currentViewDate);
                        const endOfWeek = new Date(startOfViewWeek);
                        endOfWeek.setDate(startOfViewWeek.getDate() + 6);
                        endOfWeek.setHours(23, 59, 59, 999);

                        // If viewing an archived week, use its specific spending data for the prompt
                        const archivedSummaryForPrompt = currentData.historicalSummaries.find(summary => {
                            const summaryDate = new Date(summary.date + 'T00:00:00');
                            return summaryDate.getTime() === startOfViewWeek.getTime();
                        });

                        const totalActualVariableSpendingForPrompt = archivedSummaryForPrompt ? 
                                                                    archivedSummaryForPrompt.actualVariableSpendingLog.reduce((sum, e) => sum + e.amount, 0) :
                                                                    (currentData.actualVariableSpendingLog || []).filter(entry => {
                                                                        const entryDate = new Date(entry.date + 'T00::00');
                                                                        return entryDate >= startOfViewWeek && entryDate <= endOfWeek;
                                                                    }).reduce((sum, e) => sum + e.amount, 0);

                        const weeklySavingsGoal = currentData.savingsGoal.weeklyContribution;
                        const netPosition = income - totalFixedExpenses - totalActualVariableSpendingForPrompt - weeklySavingsGoal;

                        let prompt = `Given the following weekly financial data for the week starting ${formatDate(startOfViewWeek)}:
                        - Combined Weekly Income: ${formatCurrency(income)}
                        - Total Fixed Expenses: ${formatCurrency(totalFixedExpenses)}
                        - Total Actual Variable Spending: ${formatCurrency(totalActualVariableSpendingForPrompt)}
                        - Weekly Savings Goal: ${formatCurrency(weeklySavingsGoal)}
                        - Net Weekly Position (Income - Expenses - Savings): ${formatCurrency(netPosition)}

                        Provide 3 actionable and practical financial tips to improve the net position, reduce expenses, or reach the savings goal faster. Focus on household budgeting advice. Present the tips as a concise, numbered list.`;

                        // Add details about top variable spending if available for the CURRENTLY VIEWED week
                        const actualSpendingForPrompt = archivedSummaryForPrompt ? archivedSummaryForPrompt.actualVariableSpendingLog : currentData.actualVariableSpendingLog;

                        const actualSpendingByCategory = actualSpendingForPrompt.filter(entry => {
                            const entryDate = new Date(entry.date + 'T00:00:00');
                            return entryDate >= startOfViewWeek && entryDate <= endOfWeek;
                        }).reduce((acc, item) => {
                            acc[item.category] = (acc[item.category] || 0) + item.amount;
                            return acc;
                        }, {});
                        const topSpending = Object.entries(actualSpendingByCategory)
                            .map(([name, amount]) => ({ name, amount }))
                            .sort((a, b) => b.amount - a.amount)
                            .slice(0, 3);
                        
                        if (topSpending.length > 0) {
                            prompt += `\n\nYour top variable spending categories this week are: ${topSpending.map(s => `${s.name} (${formatCurrency(s.amount)})`).join(', ')}.`;
                        }

                        let chatHistory = [];
                        chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                        const payload = { contents: chatHistory };
                        // Use __api_key if available from the Canvas environment, otherwise fallback to empty string
                        const apiKey = typeof __api_key !== 'undefined' ? __api_key : ''; 
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(`API error: ${response.status} ${response.statusText} - ${errorData.error.message}`);
                        }

                        const result = await response.json();
                        
                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            const text = result.candidates[0].content.parts[0].text;
                            tipsOutputDiv.innerHTML = `<h3 class="font-semibold mb-2">Personalized Financial Tips:</h3><p>${text.replace(/\n/g, '<br>')}</p>`;
                            tipsOutputDiv.classList.remove('hidden');
                            showToast('Financial tips generated!', 'success');
                        } else {
                            tipsOutputDiv.textContent = 'Could not generate tips. Please try again.';
                            tipsOutputDiv.classList.remove('hidden');
                            showToast('Failed to generate tips.', 'error');
                            console.error('Gemini API response structure unexpected:', result);
                        }
                    } catch (error) {
                        console.error('Error calling Gemini API:', error);
                        tipsOutputDiv.textContent = `Error generating tips: ${error.message}. Please try again later.`;
                        tipsOutputDiv.classList.remove('hidden');
                        showToast('Error generating tips.', 'error');
                    } finally {
                        llmSpinner.classList.add('hidden'); // Hide spinner
                    }
                });

                // New: Dark Mode Toggle Listener
                document.getElementById('dark-mode-toggle').addEventListener('click', () => {
                    document.body.classList.toggle('dark-mode');
                    const isDarkMode = document.body.classList.contains('dark-mode');
                    localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
                    document.getElementById('dark-mode-icon').className = 'fas fa-moon';
                    // Re-render charts to adapt to new theme colors (if any)
                    processAndRenderData(currentData, currentViewDate);
                });

                // New: Week navigation listeners
                document.getElementById('prev-week-btn').addEventListener('click', () => {
                    const newDate = new Date(currentViewDate);
                    newDate.setDate(newDate.getDate() - 7);
                    processAndRenderData(currentData, newDate);
                });

                document.getElementById('next-week-btn').addEventListener('click', () => { 
                    const newDate = new Date(currentViewDate);
                    newDate.setDate(newDate.getDate() + 7);
                    processAndRenderData(currentData, newDate);
                });

                document.getElementById('week-selector').addEventListener('change', (event) => {
                    const selectedDate = new Date(event.target.value + 'T00:00:00'); // Ensure UTC for consistency
                    processAndRenderData(currentData, selectedDate);
                });

                // New: Expense Trend Category Select Listener
                document.getElementById('trend-category-select').addEventListener('change', (event) => {
                    updateExpenseTrendChart(currentData.historicalSummaries, event.target.value);
                });
            }

            // Function to archive current week's data
            function archiveCurrentWeek(weekToArchiveDate) {
                const startOfWeekToArchive = window.getStartOfWeek(weekToArchiveDate);
                const endOfWeekToArchive = new Date(startOfWeekToArchive);
                endOfWeekToArchive.setDate(startOfWeekToArchive.getDate() + 6);
                endOfWeekToArchive.setHours(23, 59, 59, 999);

                // Calculate actual variable spending breakdown for the week being archived
                const actualVariableSpendingForArchivedWeek = (currentData.actualVariableSpendingLog || []).filter(entry => {
                    const entryDate = new Date(entry.date + 'T00:00:00');
                    return entryDate >= startOfWeekToArchive && entryDate <= endOfWeekToArchive;
                });

                const actualSpendingBreakdown = actualVariableSpendingForArchivedWeek.reduce((acc, item) => {
                    acc[item.category] = (acc[item.category] || 0) + item.amount;
                    return acc;
                }, {});

                const processed = { 
                    fixedExpensesWeekly: currentData.fixedExpenses.map(e => ({
                        category: e.category, 
                        provider: e.provider, 
                        weekly: getWeeklyAmount(e.amount, e.freq)
                    })),
                    get totalFixedWeekly() { return this.fixedExpensesWeekly.reduce((sum, e) => sum + e.weekly, 0); },
                    get totalVariableBudget() { return currentData.variableExpenses.reduce((sum, e) => sum + e.budget, 0); }, 
                    get totalActualVariableSpending() { 
                        return actualVariableSpendingForArchivedWeek.reduce((sum, e) => sum + e.amount, 0); 
                    }, 
                };

                // Calculate variable spending difference for the archived week
                const totalVariableBudgetForArchivedWeek = currentData.variableExpenses.reduce((sum, e) => sum + e.budget, 0);
                const variableSpendingDifferenceForArchivedWeek = totalVariableBudgetForArchivedWeek - processed.totalActualVariableSpending;

                // Calculate carry-over for the week being archived (this is the carry over *into* this week)
                let carryOverForArchivedWeek = 0;
                const prevWeekStartDateForArchive = new Date(startOfWeekToArchive);
                prevWeekStartDateForArchive.setDate(prevWeekStartDateForArchive.getDate() - 7);
                const previousWeekSummaryForArchive = currentData.historicalSummaries.find(summary => 
                    new Date(summary.date + 'T00:00:00').getTime() === prevWeekStartDateForArchive.getTime()
                );

                if (previousWeekSummaryForArchive) {
                    carryOverForArchivedWeek = previousWeekSummaryForArchive.netPosition;
                }

                // Net position for the week being archived, including its own carry-over
                const netWeeklyPositionForArchive = currentData.income.combined - processed.totalFixedWeekly - processed.totalActualVariableSpending - currentData.savingsGoal.weeklyContribution + carryOverForArchivedWeek;

                const weekSummary = {
                    date: window.toYYYYMMDD(startOfWeekToArchive), // Store start date of the archived week
                    incomeCombined: currentData.income.combined,
                    totalFixedExpenses: processed.totalFixedWeekly,
                    totalVariableBudget: totalVariableBudgetForArchivedWeek, // Store the budgeted amount for variable expenses
                    actualVariableSpendingLog: actualVariableSpendingForArchivedWeek, // Store detailed log for the archived week
                    totalActualVariableSpending: processed.totalActualVariableSpending,
                    actualVariableSpendingBreakdown: actualSpendingBreakdown, // New: Store breakdown
                    variableSpendingDifference: variableSpendingDifferenceForArchivedWeek, // New: Store variable spending difference
                    savingsContribution: currentData.savingsGoal.weeklyContribution,
                    netPosition: netWeeklyPositionForArchive,
                    variableExpensesAtArchive: JSON.parse(JSON.stringify(currentData.variableExpenses)) // Store variable expenses with their budgets at archive time
                };

                if (!currentData.historicalSummaries) {
                    currentData.historicalSummaries = [];
                }
                currentData.historicalSummaries.push(weekSummary);
                console.log("Archived week summary:", weekSummary);
                console.log("Historical summaries count:", currentData.historicalSummaries.length);

                // Filter out the archived transactions from the main actualVariableSpendingLog
                currentData.actualVariableSpendingLog = currentData.actualVariableSpendingLog.filter(entry => {
                    const entryDate = new Date(entry.date + 'T00:00:00');
                    return entryDate < startOfWeekToArchive || entryDate > endOfWeekToArchive;
                });

                // Reset variable expense budgets to 0 for the new week
                currentData.variableExpenses.forEach(category => {
                    category.budget = 0;
                });

                // Move to the next week automatically after archiving
                const nextWeekDate = new Date(startOfWeekToArchive);
                nextWeekDate.setDate(nextWeekDate.getDate() + 7);
                currentViewDate = nextWeekDate; // Update global view date to next week

                processAndRenderData(currentData, currentViewDate); 
                saveData(currentData); 
            }

            // Function to populate inputs and render dashboard from loaded data
            function populateInputsAndRender(data, initialViewDate) {
                console.log("Starting populateInputsAndRender with data:", data);
                // Populate income inputs
                document.getElementById('input-emma-income').value = data.income.emma;
                document.getElementById('input-jordan-income').value = data.income.jordan;
                updateCombinedIncomeInput(); 

                // Populate fixed expenses inputs
                populateFixedExpensesInputs(data.fixedExpenses);

                // Populate savings goal inputs (target, contribution, start date)
                document.getElementById('input-savings-target').value = data.savingsGoal.target;
                document.getElementById('input-weekly-contribution').value = data.savingsGoal.weeklyContribution;
                document.getElementById('input-savings-start-date').value = data.savingsGoal.startDate;
                document.getElementById('input-savings-current').value = data.savingsGoal.current; 

                // Populate notification email
                document.getElementById('input-notification-email').value = data.notificationEmail || '';

                // Process and render all dashboard sections based on the loaded data
                processAndRenderData(data, initialViewDate); 
                renderActualSavingsLog();
                renderActualSavingsUsedLog();
                // renderActualVariableSpendingLog and renderVariableSpendingSummary are called by processAndRenderData
                updateHistoricalChart(data.historicalSummaries || []); 
                populateVariableCategoryDropdown(); // Ensure dropdown is updated
                renderVariableCategoriesManagement(); // Render the management list
                updateExpenseTrendChart(data.historicalSummaries, document.getElementById('trend-category-select').value); // Initial render of trend chart
                
                // Set the initial date for the spending log input to today's date
                document.getElementById('input-actual-variable-date').value = window.toYYYYMMDD(new Date());

                console.log("Finished populateInputsAndRender. Dashboard rendering complete.");
            }

            // Attach tab switching event listeners immediately on DOMContentLoaded
            const tabs = document.querySelectorAll('.tab-button');
            const panes = document.querySelectorAll('.tab-pane');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('tab-active'));
                    tab.classList.add('tab-active');

                    panes.forEach(pane => {
                        if (pane.id === tab.dataset.tab) {
                            pane.classList.remove('hidden');
                        } else {
                            pane.classList.add('hidden');
                        }
                    });
                });
            });

            // Initial dark mode check
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('dark-mode-icon').className = 'fas fa-moon';
            } else {
                document.getElementById('dark-mode-icon').className = 'fas fa-sun';
            }


            async function initializeFirebaseAndLoadData() {
                console.log("Attempting to initialize Firebase and load data...");
                console.log("Current Date (new Date()):", new Date());
                console.log("Start of Current Week (Wednesday):", window.getStartOfWeek(new Date()));

                try {
                    const app = initializeApp(firebaseConfig);
                    console.log("Firebase app initialized.");
                    db = getFirestore(app);
                    auth = getAuth(app);
                    analytics = getAnalytics(app); // Initialize analytics
                    console.log("Firebase services (Firestore, Auth, Analytics) obtained.");

                    console.log("Attempting anonymous sign-in...");
                    const userCredential = await signInAnonymously(auth);
                    userId = userCredential.user.uid; 
                    console.log('Anonymous user signed in. User ID:', userId);

                    // Attach event listeners ONLY after Firebase is ready
                    attachFirebaseDependentEventListeners();

                    // Using the fixed, shared document path for all users/devices
                    console.log(`Setting up Firestore onSnapshot listener for SHARED path: artifacts/${appId}/sharedData/financialDashboard`);
                    const docRef = doc(db, 'artifacts', appId, 'sharedData', 'financialDashboard');
                    onSnapshot(docRef, (docSnap) => {
                        console.log("Firestore onSnapshot callback triggered for shared data.");
                        
                        if (docSnap.exists()) {
                            let loadedData = docSnap.data();
                            console.log("Data loaded from Firestore:", loadedData); 

                            // Ensure logs and arrays are valid objects/arrays, falling back to empty if undefined or null
                            loadedData.income = loadedData.income || {};
                            loadedData.income.emma = loadedData.income.emma ?? defaultData.income.emma; 
                            loadedData.income.jordan = loadedData.income.jordan ?? defaultData.income.jordan;
                            loadedData.income.combined = loadedData.income.combined ?? defaultData.income.combined;

                            loadedData.fixedExpenses = loadedData.fixedExpenses || [];
                            
                            // Load variableExpenses, ensuring new categories added by user persist
                            let mergedVariableExpenses = loadedData.variableExpenses || []; // Start with loaded categories
                            defaultData.variableExpenses.forEach(defaultVar => {
                                // Add default categories if they don't already exist in loaded data
                                if (!mergedVariableExpenses.some(lv => lv.name === defaultVar.name)) {
                                    mergedVariableExpenses.push({ ...defaultVar }); // Add with default budget (which is 0 in defaultData)
                                }
                            });
                            loadedData.variableExpenses = mergedVariableExpenses;
                            
                            loadedData.savingsGoal = loadedData.savingsGoal || {};
                            loadedData.savingsGoal.actualSavingsLog = loadedData.savingsGoal.actualSavingsLog || [];
                            loadedData.savingsGoal.actualSavingsUsedLog = loadedData.savingsGoal.actualSavingsUsedLog || [];
                            loadedData.savingsGoal.current = loadedData.savingsGoal.current ?? defaultData.savingsGoal.current;
                            loadedData.savingsGoal.target = loadedData.savingsGoal.target ?? defaultData.savingsGoal.target;
                            loadedData.savingsGoal.weeklyContribution = loadedData.savingsGoal.weeklyContribution ?? defaultData.savingsGoal.weeklyContribution;
                            loadedData.savingsGoal.startDate = loadedData.savingsGoal.startDate || defaultData.savingsGoal.startDate;
                            loadedData.savingsGoal.milestonesReached = loadedData.savingsGoal.milestonesReached || []; // Initialize if missing

                            loadedData.actualVariableSpendingLog = loadedData.actualVariableSpendingLog || [];
                            // Ensure actualVariableSpendingBreakdown and actualVariableSpendingLog are initialized for historical summaries
                            loadedData.historicalSummaries = (loadedData.historicalSummaries || []).map(summary => ({
                                ...summary,
                                actualVariableSpendingBreakdown: summary.actualVariableSpendingBreakdown || {},
                                variableSpendingDifference: summary.variableSpendingDifference ?? 0, // Initialize if missing
                                actualVariableSpendingLog: summary.actualVariableSpendingLog || [], // Ensure detailed log is present
                                variableExpensesAtArchive: summary.variableExpensesAtArchive || [] // Ensure variable expenses at archive are present
                            })); 
                            loadedData.notificationEmail = loadedData.notificationEmail || ''; // Initialize notification email

                            console.log("Current savings after data loading (from onSnapshot):", loadedData.savingsGoal.current);
                            // Use the loaded data to populate and render, starting from today's week
                            populateInputsAndRender(loadedData, new Date()); // Pass new Date() for initial view
                            loadingOverlay.style.display = 'none'; 
                        } else {
                            console.log("No financial data found in Firestore for the shared document, initializing with default data and saving.");
                            currentData = JSON.parse(JSON.stringify(defaultData)); 
                            populateInputsAndRender(currentData, new Date()); // Pass new Date() for initial view
                            saveData(currentData); 
                            loadingOverlay.style.display = 'none'; 
                        }
                    }, (error) => {
                        console.error("Firestore onSnapshot listener error (for shared data):", error);
                        loadingOverlay.style.display = 'none'; 
                        if (error.code === 'permission-denied') {
                            console.error("PERMISSION DENIED: Please check your Firestore Security Rules in Firebase Console. Ensure 'allow read, write: if request.auth != null;' is correctly set for the shared data path /artifacts/my-finance-dashboard/sharedData/financialDashboard.");
                        }
                        currentData = JSON.parse(JSON.stringify(defaultData)); 
                        populateInputsAndRender(currentData, new Date()); // Pass new Date() for initial view
                    });

                } catch (error) {
                    console.error("FATAL ERROR: Error initializing Firebase or signing in:", error);
                    loadingOverlay.style.display = 'none'; 
                    currentData = JSON.parse(JSON.stringify(defaultData)); 
                    populateInputsAndRender(currentData, new Date()); // Pass new Date() for initial view
                }
            }

            initializeFirebaseAndLoadData();
        });
    </script>
</body>
</html>
